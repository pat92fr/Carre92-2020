<!DOCTYPE html>
<!-- saved from url=(0057)https://www.a1k0n.net/2018/11/13/fast-line-following.html -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Fast line-following robots part 1: control – a1k0n.net</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="Andy Sloane">
    <meta name="keywords" content="">
    <link rel="canonical" href="http://www.a1k0n.net/2018/11/13/fast-line-following.html">
    <link rel="alternate" type="application/rss+xml" title="RSS Feed for a1k0n.net" href="https://www.a1k0n.net/feed.xml">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="./Fast line-following robots part 1_ control – a1k0n.net_files/pixyll.css" type="text/css">

    <!-- Fonts -->
    <link href="./Fast line-following robots part 1_ control – a1k0n.net_files/css" rel="stylesheet" type="text/css">
    <link href="./Fast line-following robots part 1_ control – a1k0n.net_files/css(1)" rel="stylesheet" type="text/css">
    

    <!-- Verifications -->
    

    <!-- Open Graph -->
    <!-- From: https://github.com/mmistakes/hpstr-jekyll-theme/blob/master/_includes/head.html -->
    <meta property="og:locale" content="en_US">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Fast line-following robots part 1&amp;colon; control">
    <meta property="og:description" content="">
    <meta property="og:url" content="http://www.a1k0n.net/2018/11/13/fast-line-following.html">
    <meta property="og:site_name" content="a1k0n.net">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary">
    
    <meta name="twitter:title" content="Fast line-following robots part 1: control">
    <meta name="twitter:description" content="">
    <meta name="twitter:url" content="http://www.a1k0n.net/2018/11/13/fast-line-following.html">

    
    <script type="text/javascript" async="" src="./Fast line-following robots part 1_ control – a1k0n.net_files/ga.js.téléchargement"></script><script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-24584703-1']);
      _gaq.push(['_trackPageview']);
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
    
<script type="text/javascript" async="" src="./Fast line-following robots part 1_ control – a1k0n.net_files/MathJax.js.téléchargement"></script>
<script type="text/javascript" src="./Fast line-following robots part 1_ control – a1k0n.net_files/steering.js.téléchargement"></script><style type="text/css">.MathJax_Hover_Frame {border-radius: .25em; -webkit-border-radius: .25em; -moz-border-radius: .25em; -khtml-border-radius: .25em; box-shadow: 0px 0px 15px #83A; -webkit-box-shadow: 0px 0px 15px #83A; -moz-box-shadow: 0px 0px 15px #83A; -khtml-box-shadow: 0px 0px 15px #83A; border: 1px solid #A6D ! important; display: inline-block; position: absolute}
.MathJax_Menu_Button .MathJax_Hover_Arrow {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 4px; -webkit-border-radius: 4px; -moz-border-radius: 4px; -khtml-border-radius: 4px; font-family: 'Courier New',Courier; font-size: 9px; color: #F0F0F0}
.MathJax_Menu_Button .MathJax_Hover_Arrow span {display: block; background-color: #AAA; border: 1px solid; border-radius: 3px; line-height: 0; padding: 4px}
.MathJax_Hover_Arrow:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_Hover_Arrow:hover span {background-color: #CCC!important}
</style><style type="text/css">#MathJax_About {position: fixed; left: 50%; width: auto; text-align: center; border: 3px outset; padding: 1em 2em; background-color: #DDDDDD; color: black; cursor: default; font-family: message-box; font-size: 120%; font-style: normal; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 15px; -webkit-border-radius: 15px; -moz-border-radius: 15px; -khtml-border-radius: 15px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_About.MathJax_MousePost {outline: none}
.MathJax_Menu {position: absolute; background-color: white; color: black; width: auto; padding: 2px; border: 1px solid #CCCCCC; margin: 0; cursor: default; font: menu; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_MenuItem {padding: 2px 2em; background: transparent}
.MathJax_MenuArrow {position: absolute; right: .5em; padding-top: .25em; color: #666666; font-size: .75em}
.MathJax_MenuActive .MathJax_MenuArrow {color: white}
.MathJax_MenuArrow.RTL {left: .5em; right: auto}
.MathJax_MenuCheck {position: absolute; left: .7em}
.MathJax_MenuCheck.RTL {right: .7em; left: auto}
.MathJax_MenuRadioCheck {position: absolute; left: 1em}
.MathJax_MenuRadioCheck.RTL {right: 1em; left: auto}
.MathJax_MenuLabel {padding: 2px 2em 4px 1.33em; font-style: italic}
.MathJax_MenuRule {border-top: 1px solid #CCCCCC; margin: 4px 1px 0px}
.MathJax_MenuDisabled {color: GrayText}
.MathJax_MenuActive {background-color: Highlight; color: HighlightText}
.MathJax_MenuDisabled:focus, .MathJax_MenuLabel:focus {background-color: #E8E8E8}
.MathJax_ContextMenu:focus {outline: none}
.MathJax_ContextMenu .MathJax_MenuItem:focus {outline: none}
#MathJax_AboutClose {top: .2em; right: .2em}
.MathJax_Menu .MathJax_MenuClose {top: -10px; left: -10px}
.MathJax_MenuClose {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; font-family: 'Courier New',Courier; font-size: 24px; color: #F0F0F0}
.MathJax_MenuClose span {display: block; background-color: #AAA; border: 1.5px solid; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; line-height: 0; padding: 8px 0 6px}
.MathJax_MenuClose:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_MenuClose:hover span {background-color: #CCC!important}
.MathJax_MenuClose:hover:focus {outline: none}
</style><style type="text/css">.MathJax_Preview .MJXf-math {color: inherit!important}
</style><style type="text/css">.MJX_Assistive_MathML {position: absolute!important; top: 0; left: 0; clip: rect(1px, 1px, 1px, 1px); padding: 1px 0 0 0!important; border: 0!important; height: 1px!important; width: 1px!important; overflow: hidden!important; display: block!important; -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none}
.MJX_Assistive_MathML.MJX_Assistive_MathML_Block {width: 100%!important}
</style><style type="text/css">#MathJax_Zoom {position: absolute; background-color: #F0F0F0; overflow: auto; display: block; z-index: 301; padding: .5em; border: 1px solid black; margin: 0; font-weight: normal; font-style: normal; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; -webkit-box-sizing: content-box; -moz-box-sizing: content-box; box-sizing: content-box; box-shadow: 5px 5px 15px #AAAAAA; -webkit-box-shadow: 5px 5px 15px #AAAAAA; -moz-box-shadow: 5px 5px 15px #AAAAAA; -khtml-box-shadow: 5px 5px 15px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_ZoomOverlay {position: absolute; left: 0; top: 0; z-index: 300; display: inline-block; width: 100%; height: 100%; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
#MathJax_ZoomFrame {position: relative; display: inline-block; height: 0; width: 0}
#MathJax_ZoomEventTrap {position: absolute; left: 0; top: 0; z-index: 302; display: inline-block; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
</style><style type="text/css">.MathJax_Preview {color: #888}
#MathJax_Message {position: fixed; left: 1em; bottom: 1.5em; background-color: #E6E6E6; border: 1px solid #959595; margin: 0px; padding: 2px 8px; z-index: 102; color: black; font-size: 80%; width: auto; white-space: nowrap}
#MathJax_MSIE_Frame {position: absolute; top: 0; left: 0; width: 0px; z-index: 101; border: 0px; margin: 0px; padding: 0px}
.MathJax_Error {color: #CC0000; font-style: italic}
</style>

<style type="text/css">.MJXp-script {font-size: .8em}
.MJXp-right {-webkit-transform-origin: right; -moz-transform-origin: right; -ms-transform-origin: right; -o-transform-origin: right; transform-origin: right}
.MJXp-bold {font-weight: bold}
.MJXp-italic {font-style: italic}
.MJXp-scr {font-family: MathJax_Script,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-frak {font-family: MathJax_Fraktur,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-sf {font-family: MathJax_SansSerif,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-cal {font-family: MathJax_Caligraphic,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-mono {font-family: MathJax_Typewriter,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-largeop {font-size: 150%}
.MJXp-largeop.MJXp-int {vertical-align: -.2em}
.MJXp-math {display: inline-block; line-height: 1.2; text-indent: 0; font-family: 'Times New Roman',Times,STIXGeneral,serif; white-space: nowrap; border-collapse: collapse}
.MJXp-display {display: block; text-align: center; margin: 1em 0}
.MJXp-math span {display: inline-block}
.MJXp-box {display: block!important; text-align: center}
.MJXp-box:after {content: " "}
.MJXp-rule {display: block!important; margin-top: .1em}
.MJXp-char {display: block!important}
.MJXp-mo {margin: 0 .15em}
.MJXp-mfrac {margin: 0 .125em; vertical-align: .25em}
.MJXp-denom {display: inline-table!important; width: 100%}
.MJXp-denom > * {display: table-row!important}
.MJXp-surd {vertical-align: top}
.MJXp-surd > * {display: block!important}
.MJXp-script-box > *  {display: table!important; height: 50%}
.MJXp-script-box > * > * {display: table-cell!important; vertical-align: top}
.MJXp-script-box > *:last-child > * {vertical-align: bottom}
.MJXp-script-box > * > * > * {display: block!important}
.MJXp-mphantom {visibility: hidden}
.MJXp-munderover {display: inline-table!important}
.MJXp-over {display: inline-block!important; text-align: center}
.MJXp-over > * {display: block!important}
.MJXp-munderover > * {display: table-row!important}
.MJXp-mtable {vertical-align: .25em; margin: 0 .125em}
.MJXp-mtable > * {display: inline-table!important; vertical-align: middle}
.MJXp-mtr {display: table-row!important}
.MJXp-mtd {display: table-cell!important; text-align: center; padding: .5em 0 0 .5em}
.MJXp-mtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-mlabeledtr {display: table-row!important}
.MJXp-mlabeledtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mlabeledtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-merror {background-color: #FFFF88; color: #CC0000; border: 1px solid #CC0000; padding: 1px 3px; font-style: normal; font-size: 90%}
.MJXp-scale0 {-webkit-transform: scaleX(.0); -moz-transform: scaleX(.0); -ms-transform: scaleX(.0); -o-transform: scaleX(.0); transform: scaleX(.0)}
.MJXp-scale1 {-webkit-transform: scaleX(.1); -moz-transform: scaleX(.1); -ms-transform: scaleX(.1); -o-transform: scaleX(.1); transform: scaleX(.1)}
.MJXp-scale2 {-webkit-transform: scaleX(.2); -moz-transform: scaleX(.2); -ms-transform: scaleX(.2); -o-transform: scaleX(.2); transform: scaleX(.2)}
.MJXp-scale3 {-webkit-transform: scaleX(.3); -moz-transform: scaleX(.3); -ms-transform: scaleX(.3); -o-transform: scaleX(.3); transform: scaleX(.3)}
.MJXp-scale4 {-webkit-transform: scaleX(.4); -moz-transform: scaleX(.4); -ms-transform: scaleX(.4); -o-transform: scaleX(.4); transform: scaleX(.4)}
.MJXp-scale5 {-webkit-transform: scaleX(.5); -moz-transform: scaleX(.5); -ms-transform: scaleX(.5); -o-transform: scaleX(.5); transform: scaleX(.5)}
.MJXp-scale6 {-webkit-transform: scaleX(.6); -moz-transform: scaleX(.6); -ms-transform: scaleX(.6); -o-transform: scaleX(.6); transform: scaleX(.6)}
.MJXp-scale7 {-webkit-transform: scaleX(.7); -moz-transform: scaleX(.7); -ms-transform: scaleX(.7); -o-transform: scaleX(.7); transform: scaleX(.7)}
.MJXp-scale8 {-webkit-transform: scaleX(.8); -moz-transform: scaleX(.8); -ms-transform: scaleX(.8); -o-transform: scaleX(.8); transform: scaleX(.8)}
.MJXp-scale9 {-webkit-transform: scaleX(.9); -moz-transform: scaleX(.9); -ms-transform: scaleX(.9); -o-transform: scaleX(.9); transform: scaleX(.9)}
.MathJax_PHTML .noError {vertical-align: ; font-size: 90%; text-align: left; color: black; padding: 1px 3px; border: 1px solid}
</style><style type="text/css">.MathJax_Display {text-align: center; margin: 1em 0em; position: relative; display: block!important; text-indent: 0; max-width: none; max-height: none; min-width: 0; min-height: 0; width: 100%}
.MathJax .merror {background-color: #FFFF88; color: #CC0000; border: 1px solid #CC0000; padding: 1px 3px; font-style: normal; font-size: 90%}
.MathJax .MJX-monospace {font-family: monospace}
.MathJax .MJX-sans-serif {font-family: sans-serif}
#MathJax_Tooltip {background-color: InfoBackground; color: InfoText; border: 1px solid black; box-shadow: 2px 2px 5px #AAAAAA; -webkit-box-shadow: 2px 2px 5px #AAAAAA; -moz-box-shadow: 2px 2px 5px #AAAAAA; -khtml-box-shadow: 2px 2px 5px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true'); padding: 3px 4px; z-index: 401; position: absolute; left: 0; top: 0; width: auto; height: auto; display: none}
.MathJax {display: inline; font-style: normal; font-weight: normal; line-height: normal; font-size: 100%; font-size-adjust: none; text-indent: 0; text-align: left; text-transform: none; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; direction: ltr; max-width: none; max-height: none; min-width: 0; min-height: 0; border: 0; padding: 0; margin: 0}
.MathJax:focus, body :focus .MathJax {display: inline-table}
.MathJax.MathJax_FullWidth {text-align: center; display: table-cell!important; width: 10000em!important}
.MathJax img, .MathJax nobr, .MathJax a {border: 0; padding: 0; margin: 0; max-width: none; max-height: none; min-width: 0; min-height: 0; vertical-align: 0; line-height: normal; text-decoration: none}
img.MathJax_strut {border: 0!important; padding: 0!important; margin: 0!important; vertical-align: 0!important}
.MathJax span {display: inline; position: static; border: 0; padding: 0; margin: 0; vertical-align: 0; line-height: normal; text-decoration: none}
.MathJax nobr {white-space: nowrap!important}
.MathJax img {display: inline!important; float: none!important}
.MathJax * {transition: none; -webkit-transition: none; -moz-transition: none; -ms-transition: none; -o-transition: none}
.MathJax_Processing {visibility: hidden; position: fixed; width: 0; height: 0; overflow: hidden}
.MathJax_Processed {display: none!important}
.MathJax_ExBox {display: block!important; overflow: hidden; width: 1px; height: 60ex; min-height: 0; max-height: none}
.MathJax .MathJax_EmBox {display: block!important; overflow: hidden; width: 1px; height: 60em; min-height: 0; max-height: none}
.MathJax_LineBox {display: table!important}
.MathJax_LineBox span {display: table-cell!important; width: 10000em!important; min-width: 0; max-width: none; padding: 0; border: 0; margin: 0}
.MathJax .MathJax_HitBox {cursor: text; background: white; opacity: 0; filter: alpha(opacity=0)}
.MathJax .MathJax_HitBox * {filter: none; opacity: 1; background: transparent}
#MathJax_Tooltip * {filter: none; opacity: 1; background: transparent}
@font-face {font-family: MathJax_Main; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/fonts/HTML-CSS/TeX/woff/MathJax_Main-Regular.woff?V=2.7.0') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/fonts/HTML-CSS/TeX/otf/MathJax_Main-Regular.otf?V=2.7.0') format('opentype')}
@font-face {font-family: MathJax_Main-bold; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/fonts/HTML-CSS/TeX/woff/MathJax_Main-Bold.woff?V=2.7.0') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/fonts/HTML-CSS/TeX/otf/MathJax_Main-Bold.otf?V=2.7.0') format('opentype')}
@font-face {font-family: MathJax_Main-italic; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/fonts/HTML-CSS/TeX/woff/MathJax_Main-Italic.woff?V=2.7.0') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/fonts/HTML-CSS/TeX/otf/MathJax_Main-Italic.otf?V=2.7.0') format('opentype')}
@font-face {font-family: MathJax_Math-italic; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/fonts/HTML-CSS/TeX/woff/MathJax_Math-Italic.woff?V=2.7.0') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/fonts/HTML-CSS/TeX/otf/MathJax_Math-Italic.otf?V=2.7.0') format('opentype')}
@font-face {font-family: MathJax_Caligraphic; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/fonts/HTML-CSS/TeX/woff/MathJax_Caligraphic-Regular.woff?V=2.7.0') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/fonts/HTML-CSS/TeX/otf/MathJax_Caligraphic-Regular.otf?V=2.7.0') format('opentype')}
@font-face {font-family: MathJax_Size1; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/fonts/HTML-CSS/TeX/woff/MathJax_Size1-Regular.woff?V=2.7.0') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/fonts/HTML-CSS/TeX/otf/MathJax_Size1-Regular.otf?V=2.7.0') format('opentype')}
@font-face {font-family: MathJax_Size2; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/fonts/HTML-CSS/TeX/woff/MathJax_Size2-Regular.woff?V=2.7.0') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/fonts/HTML-CSS/TeX/otf/MathJax_Size2-Regular.otf?V=2.7.0') format('opentype')}
@font-face {font-family: MathJax_Size3; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/fonts/HTML-CSS/TeX/woff/MathJax_Size3-Regular.woff?V=2.7.0') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/fonts/HTML-CSS/TeX/otf/MathJax_Size3-Regular.otf?V=2.7.0') format('opentype')}
@font-face {font-family: MathJax_Size4; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/fonts/HTML-CSS/TeX/woff/MathJax_Size4-Regular.woff?V=2.7.0') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/fonts/HTML-CSS/TeX/otf/MathJax_Size4-Regular.otf?V=2.7.0') format('opentype')}
.MathJax .noError {vertical-align: ; font-size: 90%; text-align: left; color: black; padding: 1px 3px; border: 1px solid}
</style><style type="text/css">@font-face {font-family: MathJax_AMS; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/fonts/HTML-CSS/TeX/woff/MathJax_AMS-Regular.woff?V=2.7.0') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/fonts/HTML-CSS/TeX/otf/MathJax_AMS-Regular.otf?V=2.7.0') format('opentype')}
</style></head>

<body class="site"><div style="visibility: hidden; overflow: hidden; position: absolute; top: 0px; height: 1px; width: auto; padding: 0px; border: 0px; margin: 0px; text-align: left; text-indent: 0px; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal;"><div id="MathJax_Hidden"></div></div><div id="MathJax_Message" style="display: none;"></div>

	

  <div class="site-wrap">
    <header class="site-header px2 px-responsive">
  <div class="mt2 wrap">
    <div class="measure">
      <a href="https://www.a1k0n.net/" class="site-title">a1k0n.net</a>
      <nav class="site-nav">
        <a href="https://www.a1k0n.net/about.html">About</a>

      </nav>
      <div class="clearfix"></div>
      
    </div>
  </div>
</header>


    <div class="post p2 p-responsive wrap" role="main">
      <div class="measure">
        <div class="post-header mb2">
  <h1>Fast line-following robots part 1: control</h1>
  <span class="post-meta">Nov 13, 2018</span><br>
  
</div>

<article class="post-content">
  <p>Since February 2016, I have been participating in
<a href="https://diyrobocars.com/">DIYRobocars</a> meetups here in the SF Bay Area,
wherein a bunch of amateur roboticists compete in autonomous time trials with
RC cars.  I had been doing very well in the competition with essentially just a
glorified line-following robot, but have lately upgraded to a full SLAM-like
approach with a planned trajectory.</p>

<p>In this series of posts I will try to brain-dump everything I’ve learned in the
last two years, and explain how my car works.</p>

<p>Here’s a race between my car and
<a href="https://twitter.com/otaviogood/">@otaviogood</a>’s
<a href="https://github.com/otaviogood/carputer">Carputer</a>, which uses an end-to-end
behavioral cloning neural network to drive. It had to dodge a lot of other
cars in training that day, which we think is why it sort of chokes when my car
cuts it off. My car is completely oblivious to other cars; the wheel-to-wheel
race here was just for fun.</p>

<iframe width="560" height="315" src="./Fast line-following robots part 1_ control – a1k0n.net_files/yT4iM6wx5DY.html" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe>

<p>In the video above you can see everything the car can see/sense: a birds-eye
view of the ground, gyroscope, accelerometer, and wheel velocity measurements.</p>

<p>Here’s a more recent video showing the current state of the same car, using a
slightly different but still fundamentally line-following strategy (instead of
following the line on the ground, it’s following a pre-optimized racing line):</p>

<iframe width="560" height="315" src="./Fast line-following robots part 1_ control – a1k0n.net_files/4Tsqox6Ziec.html" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe>

<h2 id="line-following-theory">Line-following theory</h2>

<p>Imagine you are a line following robot. Your mission is to move forward and
keep the line in the middle of your sensors (maybe they’re IR sensors looking
at the ground, maybe it’s a camera). The line can go straight or it can turn,
and so can you. As far as you’re concerned, the world consists of only you and
the line, so we need to think about your position in space relative to the
line.</p>

<h3 id="curvilinear-coordinates">Curvilinear coordinates</h3>

<p>A line-following robot lives in a <em>curvilinear</em> coordinate system: all
measurements of position are relative to a line which has some (probably
varying) curvature. Therefore instead of saying the robot has an <em>x</em>, <em>y</em>
position and maybe an angle <em>θ</em>, I try to follow the notation I’ve seen
in the robotics / automotive control literature.</p>

<p><img src="./Fast line-following robots part 1_ control – a1k0n.net_files/curvilinear1.svg"></p>

<p>We assume that the car is traveling along a circle with curvature <em>κ</em>,
which is equivalent to 1/radius <em>r</em>, except it can be either positive or
negative – in the convention I’m using, if it’s positive, the circle curves to
the left and negative curvature goes right (if this seems backwards, think
about how angles conventionally run counterclockwise on the plane, as in (<em>x</em>, <em>y</em>)
= (cos <em>θ</em>, sin <em>θ</em>)). 0 curvature of course means a perfectly straight
line.</p>

<p>At the point on the track centerline closest to the car’s position, the forward
direction is called <em>x</em> and the direction toward the left is <em>y</em>.  (Again if
<em>y</em> seems backwards, it’s because of the right-hand rule given that <em>x</em> goes
forwards.  Why is <em>x</em> forwards? Not really sure, that’s just how they tend to
do it.)</p>

<p>The distance from the car to the nearest point on the center line is called
<em>y<sub>e</sub></em>, which is positive if the car is on the left side of the
center, negative on the right. The heading angle of the car with respect to the
centerline is denoted <em>Ψ<sub>e</sub></em>, which increases as the car turns
counterclockwise with respect to the centerline.</p>

<h3 id="control-strategies">Control strategies</h3>

<p>The most obvious thing to do is to ignore everything but <em>y<sub>e</sub></em> – if
the line is on the left, then turn left, and if it’s on the right, turn right.
That’ll get you started, but it will wander back and forth and won’t work at
all when you crank up the speed. Here’s a little simulation:</p>

<h4 id="pure-proportional-control">Pure Proportional Control</h4>
<div class="container-fluid">
<canvas class="linefollower control-p" width="400" height="200"></canvas>
</div>
<fieldset>
<div>
  <label for="Kp">Kp</label><input type="range" name="Kp" min="0.1" max="3" value="1" step="0.1" class="control-p" style="width: 90%; float: right; margin: auto;">
</div>
<div>
  <label for="v">v</label><input type="range" name="v" min="0.1" max="3" value="1" step="0.1" class="control-p" style="width: 90%; float: right; margin: auto;">
</div>
</fieldset>
<p>control: <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-1-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;msup&gt;&lt;mi&gt;&amp;#x03BA;&lt;/mi&gt;&lt;mo&gt;&amp;#x2032;&lt;/mo&gt;&lt;/msup&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;K&lt;/mi&gt;&lt;mi&gt;p&lt;/mi&gt;&lt;/msub&gt;&lt;msub&gt;&lt;mi&gt;y&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;/msub&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-1" style="width: 6.604em; display: inline-block;"><span style="display: inline-block; position: relative; width: 5.158em; height: 0px; font-size: 128%;"><span style="position: absolute; clip: rect(1.408em, 1005.16em, 2.658em, -999.998em); top: -2.264em; left: 0em;"><span class="mrow" id="MathJax-Span-2"><span class="msup" id="MathJax-Span-3"><span style="display: inline-block; position: relative; width: 0.861em; height: 0px;"><span style="position: absolute; clip: rect(3.439em, 1000.55em, 4.104em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-4" style="font-family: MathJax_Math-italic;">κ</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -4.334em; left: 0.588em;"><span class="mo" id="MathJax-Span-5" style="font-size: 70.7%; font-family: MathJax_Main;">′</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span class="mo" id="MathJax-Span-6" style="font-family: MathJax_Main; padding-left: 0.275em;">=</span><span class="mo" id="MathJax-Span-7" style="font-family: MathJax_Main; padding-left: 0.275em;">−</span><span class="msubsup" id="MathJax-Span-8"><span style="display: inline-block; position: relative; width: 1.291em; height: 0px;"><span style="position: absolute; clip: rect(3.205em, 1000.9em, 4.104em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-9" style="font-family: MathJax_Math-italic;">K<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.041em;"></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -3.826em; left: 0.861em;"><span class="mi" id="MathJax-Span-10" style="font-size: 70.7%; font-family: MathJax_Math-italic;">p</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span class="msubsup" id="MathJax-Span-11"><span style="display: inline-block; position: relative; width: 0.9em; height: 0px;"><span style="position: absolute; clip: rect(3.439em, 1000.51em, 4.299em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-12" style="font-family: MathJax_Math-italic;">y<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -3.826em; left: 0.51em;"><span class="mi" id="MathJax-Span-13" style="font-size: 70.7%; font-family: MathJax_Math-italic;">e</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.268em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.398em; border-left: 0px solid; width: 0px; height: 1.453em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mi>κ</mi><mo>′</mo></msup><mo>=</mo><mo>−</mo><msub><mi>K</mi><mi>p</mi></msub><msub><mi>y</mi><mi>e</mi></msub></math></span></span><script type="math/tex" id="MathJax-Element-1">\kappa' = -K_p y_e</script></p>

<p>This is the <a href="https://twitter.com/a1k0n/status/845839637205594114">first
thing I tried</a>, and is about as far as many people get when making
line-following robots. But there’s a simple tweak that makes it work much
better, if you can determine not just the distance to the centerline but also
the relative angle of the line <em>Ψ<sub>e</sub></em>.</p>

<h4 id="pure-proportional-differential-control">Pure Proportional-Differential Control</h4>

<p>We need a way to damp out those oscillations, and the classical way to do that
is to add a derivative feedback term. We could either numerically differentiate
our <em>y<sub>e</sub></em> error from the last frame, or we could use the sine of the
angle between our heading and our centerline, which is pretty much equivalent
(except it doesn’t depend on velocity).</p>

<div class="container-fluid">
<canvas class="linefollower control-pd" width="400" height="200"></canvas>
</div>
<fieldset>
<div>
  <label for="Kp">Kp</label><input type="range" name="Kp" min="0.1" max="3" value="1" step="0.1" class="control-pd" style="width: 90%; float: right; margin: auto;">
</div>
<div>
  <label for="Kd">Kd</label><input type="range" name="Kd" min="0.1" max="10" value="1" step="0.1" class="control-pd" style="width: 90%; float: right; margin: auto;">
</div>
<div>
  <label for="v">v</label><input type="range" name="v" min="0.1" max="10" value="1" step="0.1" class="control-pd" style="width: 90%; float: right; margin: auto;">
</div>
</fieldset>
<p>control: <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-2-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;msup&gt;&lt;mi&gt;&amp;#x03BA;&lt;/mi&gt;&lt;mo&gt;&amp;#x2032;&lt;/mo&gt;&lt;/msup&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;K&lt;/mi&gt;&lt;mi&gt;p&lt;/mi&gt;&lt;/msub&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;y&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;/msub&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;K&lt;/mi&gt;&lt;mi&gt;d&lt;/mi&gt;&lt;/msub&gt;&lt;mi&gt;sin&lt;/mi&gt;&lt;mo&gt;&amp;#x2061;&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;&amp;#x03C8;&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;/msub&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-14" style="width: 14.221em; display: inline-block;"><span style="display: inline-block; position: relative; width: 11.096em; height: 0px; font-size: 128%;"><span style="position: absolute; clip: rect(1.408em, 1011.02em, 2.658em, -999.998em); top: -2.264em; left: 0em;"><span class="mrow" id="MathJax-Span-15"><span class="msup" id="MathJax-Span-16"><span style="display: inline-block; position: relative; width: 0.861em; height: 0px;"><span style="position: absolute; clip: rect(3.439em, 1000.55em, 4.104em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-17" style="font-family: MathJax_Math-italic;">κ</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -4.334em; left: 0.588em;"><span class="mo" id="MathJax-Span-18" style="font-size: 70.7%; font-family: MathJax_Main;">′</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span class="mo" id="MathJax-Span-19" style="font-family: MathJax_Main; padding-left: 0.275em;">=</span><span class="mo" id="MathJax-Span-20" style="font-family: MathJax_Main; padding-left: 0.275em;">−</span><span class="msubsup" id="MathJax-Span-21"><span style="display: inline-block; position: relative; width: 1.291em; height: 0px;"><span style="position: absolute; clip: rect(3.205em, 1000.9em, 4.104em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-22" style="font-family: MathJax_Math-italic;">K<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.041em;"></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -3.826em; left: 0.861em;"><span class="mi" id="MathJax-Span-23" style="font-size: 70.7%; font-family: MathJax_Math-italic;">p</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span class="mo" id="MathJax-Span-24" style="font-family: MathJax_Main;">(</span><span class="msubsup" id="MathJax-Span-25"><span style="display: inline-block; position: relative; width: 0.9em; height: 0px;"><span style="position: absolute; clip: rect(3.439em, 1000.51em, 4.299em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-26" style="font-family: MathJax_Math-italic;">y<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -3.826em; left: 0.51em;"><span class="mi" id="MathJax-Span-27" style="font-size: 70.7%; font-family: MathJax_Math-italic;">e</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span class="mo" id="MathJax-Span-28" style="font-family: MathJax_Main; padding-left: 0.236em;">+</span><span class="msubsup" id="MathJax-Span-29" style="padding-left: 0.236em;"><span style="display: inline-block; position: relative; width: 1.291em; height: 0px;"><span style="position: absolute; clip: rect(3.205em, 1000.9em, 4.104em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-30" style="font-family: MathJax_Math-italic;">K<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.041em;"></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -3.826em; left: 0.861em;"><span class="mi" id="MathJax-Span-31" style="font-size: 70.7%; font-family: MathJax_Math-italic;">d<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span class="mi" id="MathJax-Span-32" style="font-family: MathJax_Main; padding-left: 0.158em;">sin</span><span class="mo" id="MathJax-Span-33"></span><span class="msubsup" id="MathJax-Span-34" style="padding-left: 0.158em;"><span style="display: inline-block; position: relative; width: 1.057em; height: 0px;"><span style="position: absolute; clip: rect(3.166em, 1000.63em, 4.299em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-35" style="font-family: MathJax_Math-italic;">ψ</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -3.826em; left: 0.666em;"><span class="mi" id="MathJax-Span-36" style="font-size: 70.7%; font-family: MathJax_Math-italic;">e</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span class="mo" id="MathJax-Span-37" style="font-family: MathJax_Main;">)</span></span><span style="display: inline-block; width: 0px; height: 2.268em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.398em; border-left: 0px solid; width: 0px; height: 1.453em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mi>κ</mi><mo>′</mo></msup><mo>=</mo><mo>−</mo><msub><mi>K</mi><mi>p</mi></msub><mo stretchy="false">(</mo><msub><mi>y</mi><mi>e</mi></msub><mo>+</mo><msub><mi>K</mi><mi>d</mi></msub><mi>sin</mi><mo>⁡</mo><msub><mi>ψ</mi><mi>e</mi></msub><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-2">\kappa' = -K_p (y_e + K_d \sin \psi_e)</script></p>

<p>That’s a lot better, isn’t it? Only it tends to get “surprised” when there’s a
turn, and it will always overshoot. If we know the curvature of the path we’re
following, we can just add that in to our control signal.</p>

<h4 id="curvature-aware-proportional-differential-control">Curvature-aware Proportional-Differential Control</h4>

<div class="container-fluid">
<canvas class="linefollower control-pdk" width="400" height="200"></canvas>
</div>
<fieldset>
<div>
  <label for="Kp">Kp</label><input type="range" name="Kp" min="0.1" max="3" value="1" step="0.1" class="control-pdk" style="width: 90%; float: right; margin: auto;">
</div>
<div>
  <label for="Kd">Kd</label><input type="range" name="Kd" min="0.1" max="10" value="1" step="0.1" class="control-pdk" style="width: 90%; float: right; margin: auto;">
</div>
<div>
  <label for="v">v</label><input type="range" name="v" min="0.1" max="10" value="1" step="0.1" class="control-pdk" style="width: 90%; float: right; margin: auto;">
</div>
</fieldset>
<p>control: <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-3-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;msup&gt;&lt;mi&gt;&amp;#x03BA;&lt;/mi&gt;&lt;mo&gt;&amp;#x2032;&lt;/mo&gt;&lt;/msup&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;K&lt;/mi&gt;&lt;mi&gt;p&lt;/mi&gt;&lt;/msub&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;y&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;/msub&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;K&lt;/mi&gt;&lt;mi&gt;d&lt;/mi&gt;&lt;/msub&gt;&lt;mi&gt;sin&lt;/mi&gt;&lt;mo&gt;&amp;#x2061;&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;&amp;#x03C8;&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;/msub&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;mi&gt;&amp;#x03BA;&lt;/mi&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-38" style="width: 16.525em; display: inline-block;"><span style="display: inline-block; position: relative; width: 12.893em; height: 0px; font-size: 128%;"><span style="position: absolute; clip: rect(1.408em, 1012.85em, 2.658em, -999.998em); top: -2.264em; left: 0em;"><span class="mrow" id="MathJax-Span-39"><span class="msup" id="MathJax-Span-40"><span style="display: inline-block; position: relative; width: 0.861em; height: 0px;"><span style="position: absolute; clip: rect(3.439em, 1000.55em, 4.104em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-41" style="font-family: MathJax_Math-italic;">κ</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -4.334em; left: 0.588em;"><span class="mo" id="MathJax-Span-42" style="font-size: 70.7%; font-family: MathJax_Main;">′</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span class="mo" id="MathJax-Span-43" style="font-family: MathJax_Main; padding-left: 0.275em;">=</span><span class="mo" id="MathJax-Span-44" style="font-family: MathJax_Main; padding-left: 0.275em;">−</span><span class="msubsup" id="MathJax-Span-45"><span style="display: inline-block; position: relative; width: 1.291em; height: 0px;"><span style="position: absolute; clip: rect(3.205em, 1000.9em, 4.104em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-46" style="font-family: MathJax_Math-italic;">K<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.041em;"></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -3.826em; left: 0.861em;"><span class="mi" id="MathJax-Span-47" style="font-size: 70.7%; font-family: MathJax_Math-italic;">p</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span class="mo" id="MathJax-Span-48" style="font-family: MathJax_Main;">(</span><span class="msubsup" id="MathJax-Span-49"><span style="display: inline-block; position: relative; width: 0.9em; height: 0px;"><span style="position: absolute; clip: rect(3.439em, 1000.51em, 4.299em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-50" style="font-family: MathJax_Math-italic;">y<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -3.826em; left: 0.51em;"><span class="mi" id="MathJax-Span-51" style="font-size: 70.7%; font-family: MathJax_Math-italic;">e</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span class="mo" id="MathJax-Span-52" style="font-family: MathJax_Main; padding-left: 0.236em;">+</span><span class="msubsup" id="MathJax-Span-53" style="padding-left: 0.236em;"><span style="display: inline-block; position: relative; width: 1.291em; height: 0px;"><span style="position: absolute; clip: rect(3.205em, 1000.9em, 4.104em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-54" style="font-family: MathJax_Math-italic;">K<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.041em;"></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -3.826em; left: 0.861em;"><span class="mi" id="MathJax-Span-55" style="font-size: 70.7%; font-family: MathJax_Math-italic;">d<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span class="mi" id="MathJax-Span-56" style="font-family: MathJax_Main; padding-left: 0.158em;">sin</span><span class="mo" id="MathJax-Span-57"></span><span class="msubsup" id="MathJax-Span-58" style="padding-left: 0.158em;"><span style="display: inline-block; position: relative; width: 1.057em; height: 0px;"><span style="position: absolute; clip: rect(3.166em, 1000.63em, 4.299em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-59" style="font-family: MathJax_Math-italic;">ψ</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -3.826em; left: 0.666em;"><span class="mi" id="MathJax-Span-60" style="font-size: 70.7%; font-family: MathJax_Math-italic;">e</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span class="mo" id="MathJax-Span-61" style="font-family: MathJax_Main;">)</span><span class="mo" id="MathJax-Span-62" style="font-family: MathJax_Main; padding-left: 0.236em;">+</span><span class="mi" id="MathJax-Span-63" style="font-family: MathJax_Math-italic; padding-left: 0.236em;">κ</span></span><span style="display: inline-block; width: 0px; height: 2.268em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.398em; border-left: 0px solid; width: 0px; height: 1.453em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mi>κ</mi><mo>′</mo></msup><mo>=</mo><mo>−</mo><msub><mi>K</mi><mi>p</mi></msub><mo stretchy="false">(</mo><msub><mi>y</mi><mi>e</mi></msub><mo>+</mo><msub><mi>K</mi><mi>d</mi></msub><mi>sin</mi><mo>⁡</mo><msub><mi>ψ</mi><mi>e</mi></msub><mo stretchy="false">)</mo><mo>+</mo><mi>κ</mi></math></span></span><script type="math/tex" id="MathJax-Element-3">\kappa' = -K_p (y_e + K_d \sin \psi_e) + \kappa</script></p>

<p>Even better. It still overshoots a bit, but it can be made to track very
accurately. The only real issue with this is the curvature of the track
actually depends on the car’s <em>y</em> position; the inside of a turn has a higher
curvature than the outside.</p>

<p>There’s a paper from 1993 that studies this problem in depth that I’ve found
very helpful: <a href="https://hal.inria.fr/inria-00074575/en/">Trajectory
tracking for unicycle-type and two-steering-wheels mobile robots</a>.<sup id="fnref:1"><a href="https://www.a1k0n.net/2018/11/13/fast-line-following.html#fn:1" class="footnote">1</a></sup> The
authors derive a nice closed-form PD control law (a bit hairier than the above,
but not hard to compute) adjusted for curvy target trajectories.</p>

<div class="container-fluid">
<canvas class="linefollower control-rr2097" width="400" height="200"></canvas>
</div>
<fieldset>
<div>
  <label for="Kp">Kp</label><input type="range" name="Kp" min="0.1" max="3" value="1" step="0.1" class="control-rr2097" style="width: 90%; float: right; margin: auto;">
</div>
<div>
  <label for="Kd">Kd</label><input type="range" name="Kd" min="0.1" max="10" value="1" step="0.1" class="control-rr2097" style="width: 90%; float: right; margin: auto;">
</div>
<div>
  <label for="v">v</label><input type="range" name="v" min="0.1" max="10" value="1" step="0.1" class="control-rr2097" style="width: 90%; float: right; margin: auto;">
</div>
</fieldset>
<p>control: <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-4-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;msup&gt;&lt;mi&gt;&amp;#x03BA;&lt;/mi&gt;&lt;mo&gt;&amp;#x2032;&lt;/mo&gt;&lt;/msup&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mfrac&gt;&lt;mrow&gt;&lt;mi&gt;cos&lt;/mi&gt;&lt;mo&gt;&amp;#x2061;&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;&amp;#x03C8;&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;/msub&gt;&lt;/mrow&gt;&lt;mrow&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;mi&gt;&amp;#x03BA;&lt;/mi&gt;&lt;msub&gt;&lt;mi&gt;y&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;/msub&gt;&lt;/mrow&gt;&lt;/mfrac&gt;&lt;mrow&gt;&lt;mo&gt;[&lt;/mo&gt;&lt;mrow&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;K&lt;/mi&gt;&lt;mi&gt;p&lt;/mi&gt;&lt;/msub&gt;&lt;mfrac&gt;&lt;mrow&gt;&lt;msub&gt;&lt;mi&gt;y&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;/msub&gt;&lt;msup&gt;&lt;mi&gt;cos&lt;/mi&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/msup&gt;&lt;mo&gt;&amp;#x2061;&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;&amp;#x03C8;&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;/msub&gt;&lt;/mrow&gt;&lt;mrow&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;mi&gt;&amp;#x03BA;&lt;/mi&gt;&lt;msub&gt;&lt;mi&gt;y&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;/msub&gt;&lt;/mrow&gt;&lt;/mfrac&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;mi&gt;sin&lt;/mi&gt;&lt;mo&gt;&amp;#x2061;&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;&amp;#x03C8;&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;/msub&gt;&lt;mrow&gt;&lt;mo&gt;(&lt;/mo&gt;&lt;mrow&gt;&lt;mi&gt;&amp;#x03BA;&lt;/mi&gt;&lt;mi&gt;sin&lt;/mi&gt;&lt;mo&gt;&amp;#x2061;&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;&amp;#x03C8;&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;/msub&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;K&lt;/mi&gt;&lt;mi&gt;d&lt;/mi&gt;&lt;/msub&gt;&lt;mi&gt;cos&lt;/mi&gt;&lt;mo&gt;&amp;#x2061;&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;&amp;#x03C8;&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;/msub&gt;&lt;/mrow&gt;&lt;mo&gt;)&lt;/mo&gt;&lt;/mrow&gt;&lt;/mrow&gt;&lt;mo&gt;]&lt;/mo&gt;&lt;/mrow&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-64" style="width: 30.549em; display: inline-block;"><span style="display: inline-block; position: relative; width: 23.869em; height: 0px; font-size: 128%;"><span style="position: absolute; clip: rect(1.994em, 1023.63em, 4.025em, -999.998em); top: -3.24em; left: 0em;"><span class="mrow" id="MathJax-Span-65"><span class="msup" id="MathJax-Span-66"><span style="display: inline-block; position: relative; width: 0.861em; height: 0px;"><span style="position: absolute; clip: rect(3.439em, 1000.55em, 4.104em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-67" style="font-family: MathJax_Math-italic;">κ</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -4.334em; left: 0.588em;"><span class="mo" id="MathJax-Span-68" style="font-size: 70.7%; font-family: MathJax_Main;">′</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span class="mo" id="MathJax-Span-69" style="font-family: MathJax_Main; padding-left: 0.275em;">=</span><span class="mfrac" id="MathJax-Span-70" style="padding-left: 0.275em;"><span style="display: inline-block; position: relative; width: 2.072em; height: 0px; margin-right: 0.119em; margin-left: 0.119em;"><span style="position: absolute; clip: rect(3.361em, 1001.84em, 4.26em, -999.998em); top: -4.529em; left: 50%; margin-left: -0.936em;"><span class="mrow" id="MathJax-Span-71"><span class="mi" id="MathJax-Span-72" style="font-size: 70.7%; font-family: MathJax_Main;">cos</span><span class="mo" id="MathJax-Span-73" style="font-size: 70.7%;"></span><span class="msubsup" id="MathJax-Span-74" style="padding-left: 0.158em;"><span style="display: inline-block; position: relative; width: 0.744em; height: 0px;"><span style="position: absolute; clip: rect(3.361em, 1000.43em, 4.26em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-75" style="font-size: 70.7%; font-family: MathJax_Math-italic;">ψ</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -3.826em; left: 0.471em;"><span class="mi" id="MathJax-Span-76" style="font-size: 50%; font-family: MathJax_Math-italic;">e</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; clip: rect(3.4em, 1001.96em, 4.26em, -999.998em); top: -3.631em; left: 50%; margin-left: -0.975em;"><span class="mrow" id="MathJax-Span-77"><span class="mn" id="MathJax-Span-78" style="font-size: 70.7%; font-family: MathJax_Main;">1</span><span class="mo" id="MathJax-Span-79" style="font-size: 70.7%; font-family: MathJax_Main;">−</span><span class="mi" id="MathJax-Span-80" style="font-size: 70.7%; font-family: MathJax_Math-italic;">κ</span><span class="msubsup" id="MathJax-Span-81"><span style="display: inline-block; position: relative; width: 0.627em; height: 0px;"><span style="position: absolute; clip: rect(3.557em, 1000.35em, 4.26em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-82" style="font-size: 70.7%; font-family: MathJax_Math-italic;">y<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -3.826em; left: 0.354em;"><span class="mi" id="MathJax-Span-83" style="font-size: 50%; font-family: MathJax_Math-italic;">e</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; clip: rect(0.861em, 1002.07em, 1.174em, -999.998em); top: -1.287em; left: 0em;"><span style="display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.5px solid; width: 2.072em; height: 0px;"></span><span style="display: inline-block; width: 0px; height: 1.057em;"></span></span></span></span><span class="mrow" id="MathJax-Span-84"><span class="mo" id="MathJax-Span-85" style="vertical-align: 0em;"><span style="font-family: MathJax_Size2;">[</span></span><span class="mrow" id="MathJax-Span-86"><span class="mo" id="MathJax-Span-87" style="font-family: MathJax_Main;">−</span><span class="msubsup" id="MathJax-Span-88"><span style="display: inline-block; position: relative; width: 1.291em; height: 0px;"><span style="position: absolute; clip: rect(3.205em, 1000.9em, 4.104em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-89" style="font-family: MathJax_Math-italic;">K<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.041em;"></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -3.826em; left: 0.861em;"><span class="mi" id="MathJax-Span-90" style="font-size: 70.7%; font-family: MathJax_Math-italic;">p</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span class="mfrac" id="MathJax-Span-91"><span style="display: inline-block; position: relative; width: 3.049em; height: 0px; margin-right: 0.119em; margin-left: 0.119em;"><span style="position: absolute; clip: rect(3.283em, 1002.93em, 4.26em, -999.998em); top: -4.529em; left: 50%; margin-left: -1.482em;"><span class="mrow" id="MathJax-Span-92"><span class="msubsup" id="MathJax-Span-93"><span style="display: inline-block; position: relative; width: 0.627em; height: 0px;"><span style="position: absolute; clip: rect(3.557em, 1000.35em, 4.26em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-94" style="font-size: 70.7%; font-family: MathJax_Math-italic;">y<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -3.826em; left: 0.354em;"><span class="mi" id="MathJax-Span-95" style="font-size: 50%; font-family: MathJax_Math-italic;">e</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span class="msubsup" id="MathJax-Span-96" style="padding-left: 0.158em;"><span style="display: inline-block; position: relative; width: 1.252em; height: 0px;"><span style="position: absolute; clip: rect(3.557em, 1000.94em, 4.104em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-97" style="font-size: 70.7%; font-family: MathJax_Main;">cos</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -4.256em; left: 0.939em;"><span class="mn" id="MathJax-Span-98" style="font-size: 50%; font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span class="mo" id="MathJax-Span-99" style="font-size: 70.7%;"></span><span class="msubsup" id="MathJax-Span-100" style="padding-left: 0.158em;"><span style="display: inline-block; position: relative; width: 0.744em; height: 0px;"><span style="position: absolute; clip: rect(3.361em, 1000.43em, 4.26em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-101" style="font-size: 70.7%; font-family: MathJax_Math-italic;">ψ</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -3.826em; left: 0.471em;"><span class="mi" id="MathJax-Span-102" style="font-size: 50%; font-family: MathJax_Math-italic;">e</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; clip: rect(3.4em, 1001.96em, 4.26em, -999.998em); top: -3.631em; left: 50%; margin-left: -0.975em;"><span class="mrow" id="MathJax-Span-103"><span class="mn" id="MathJax-Span-104" style="font-size: 70.7%; font-family: MathJax_Main;">1</span><span class="mo" id="MathJax-Span-105" style="font-size: 70.7%; font-family: MathJax_Main;">−</span><span class="mi" id="MathJax-Span-106" style="font-size: 70.7%; font-family: MathJax_Math-italic;">κ</span><span class="msubsup" id="MathJax-Span-107"><span style="display: inline-block; position: relative; width: 0.627em; height: 0px;"><span style="position: absolute; clip: rect(3.557em, 1000.35em, 4.26em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-108" style="font-size: 70.7%; font-family: MathJax_Math-italic;">y<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -3.826em; left: 0.354em;"><span class="mi" id="MathJax-Span-109" style="font-size: 50%; font-family: MathJax_Math-italic;">e</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; clip: rect(0.861em, 1003.05em, 1.174em, -999.998em); top: -1.287em; left: 0em;"><span style="display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.5px solid; width: 3.049em; height: 0px;"></span><span style="display: inline-block; width: 0px; height: 1.057em;"></span></span></span></span><span class="mo" id="MathJax-Span-110" style="font-family: MathJax_Main; padding-left: 0.236em;">+</span><span class="mi" id="MathJax-Span-111" style="font-family: MathJax_Main; padding-left: 0.236em;">sin</span><span class="mo" id="MathJax-Span-112"></span><span class="msubsup" id="MathJax-Span-113" style="padding-left: 0.158em;"><span style="display: inline-block; position: relative; width: 1.057em; height: 0px;"><span style="position: absolute; clip: rect(3.166em, 1000.63em, 4.299em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-114" style="font-family: MathJax_Math-italic;">ψ</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -3.826em; left: 0.666em;"><span class="mi" id="MathJax-Span-115" style="font-size: 70.7%; font-family: MathJax_Math-italic;">e</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span class="mrow" id="MathJax-Span-116" style="padding-left: 0.158em;"><span class="mo" id="MathJax-Span-117" style="font-family: MathJax_Main;">(</span><span class="mrow" id="MathJax-Span-118"><span class="mi" id="MathJax-Span-119" style="font-family: MathJax_Math-italic;">κ</span><span class="mi" id="MathJax-Span-120" style="font-family: MathJax_Main; padding-left: 0.158em;">sin</span><span class="mo" id="MathJax-Span-121"></span><span class="msubsup" id="MathJax-Span-122" style="padding-left: 0.158em;"><span style="display: inline-block; position: relative; width: 1.057em; height: 0px;"><span style="position: absolute; clip: rect(3.166em, 1000.63em, 4.299em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-123" style="font-family: MathJax_Math-italic;">ψ</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -3.826em; left: 0.666em;"><span class="mi" id="MathJax-Span-124" style="font-size: 70.7%; font-family: MathJax_Math-italic;">e</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span class="mo" id="MathJax-Span-125" style="font-family: MathJax_Main; padding-left: 0.236em;">−</span><span class="msubsup" id="MathJax-Span-126" style="padding-left: 0.236em;"><span style="display: inline-block; position: relative; width: 1.291em; height: 0px;"><span style="position: absolute; clip: rect(3.205em, 1000.9em, 4.104em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-127" style="font-family: MathJax_Math-italic;">K<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.041em;"></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -3.826em; left: 0.861em;"><span class="mi" id="MathJax-Span-128" style="font-size: 70.7%; font-family: MathJax_Math-italic;">d<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span class="mi" id="MathJax-Span-129" style="font-family: MathJax_Main; padding-left: 0.158em;">cos</span><span class="mo" id="MathJax-Span-130"></span><span class="msubsup" id="MathJax-Span-131" style="padding-left: 0.158em;"><span style="display: inline-block; position: relative; width: 1.057em; height: 0px;"><span style="position: absolute; clip: rect(3.166em, 1000.63em, 4.299em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-132" style="font-family: MathJax_Math-italic;">ψ</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -3.826em; left: 0.666em;"><span class="mi" id="MathJax-Span-133" style="font-size: 70.7%; font-family: MathJax_Math-italic;">e</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span></span><span class="mo" id="MathJax-Span-134" style="font-family: MathJax_Main;">)</span></span></span><span class="mo" id="MathJax-Span-135" style="vertical-align: 0em;"><span style="font-family: MathJax_Size2;">]</span></span></span></span><span style="display: inline-block; width: 0px; height: 3.244em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.897em; border-left: 0px solid; width: 0px; height: 2.402em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mi>κ</mi><mo>′</mo></msup><mo>=</mo><mfrac><mrow><mi>cos</mi><mo>⁡</mo><msub><mi>ψ</mi><mi>e</mi></msub></mrow><mrow><mn>1</mn><mo>−</mo><mi>κ</mi><msub><mi>y</mi><mi>e</mi></msub></mrow></mfrac><mrow><mo>[</mo><mrow><mo>−</mo><msub><mi>K</mi><mi>p</mi></msub><mfrac><mrow><msub><mi>y</mi><mi>e</mi></msub><msup><mi>cos</mi><mn>2</mn></msup><mo>⁡</mo><msub><mi>ψ</mi><mi>e</mi></msub></mrow><mrow><mn>1</mn><mo>−</mo><mi>κ</mi><msub><mi>y</mi><mi>e</mi></msub></mrow></mfrac><mo>+</mo><mi>sin</mi><mo>⁡</mo><msub><mi>ψ</mi><mi>e</mi></msub><mrow><mo>(</mo><mrow><mi>κ</mi><mi>sin</mi><mo>⁡</mo><msub><mi>ψ</mi><mi>e</mi></msub><mo>−</mo><msub><mi>K</mi><mi>d</mi></msub><mi>cos</mi><mo>⁡</mo><msub><mi>ψ</mi><mi>e</mi></msub></mrow><mo>)</mo></mrow></mrow><mo>]</mo></mrow></math></span></span><script type="math/tex" id="MathJax-Element-4">\kappa' = \frac{\cos \psi_e}{1 - \kappa y_e}\left[ -K_p \frac{y_e \cos^2 \psi_e}{1 - \kappa y_e} + \sin \psi_e \left(\kappa \sin \psi_e - K_d \cos \psi_e \right) \right]</script></p>

<p>If you play around with the constants, you’ll see this one gets around the
track faster than any of the others above.</p>

<h4 id="target-velocity-in-a-curve">Target velocity in a curve</h4>

<p>The above give us control targets for curvature, but don’t say anything about
exactly how fast we should be driving in a turn.  In fact the above simulations
are just driving the motor at a constant speed, and the simulator understeers
in turns (in other words, the front wheels skid, it doesn’t actually turn as
far as it wants to, and it slows the car down).</p>

<p>Ideally we’d brake for the turns and not understeer in them. But how fast
should we go?</p>

<p>This can be very complicated due to tire dynamics and weight transfer, but the
simplest thing that works is to shoot for a given lateral acceleration – the
tires will be able to exert a certain amount of <em>g</em> force sideways, and you can
measure this by driving the car around in circles and seeing what the
accelerometer (or the product of the forward velocity and gyro yaw rate) says.</p>

<p>There’s a simple formula for lateral acceleration, and we can solve it for
velocity given a maximum lateral acceleration.</p>

<span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_Display" style="text-align: center;"><span class="MathJax" id="MathJax-Element-5-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;&gt;&lt;msub&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;L&lt;/mi&gt;&lt;/msub&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mfrac&gt;&lt;msup&gt;&lt;mi&gt;v&lt;/mi&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/msup&gt;&lt;mi&gt;r&lt;/mi&gt;&lt;/mfrac&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;msup&gt;&lt;mi&gt;v&lt;/mi&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/msup&gt;&lt;mi&gt;&amp;#x03BA;&lt;/mi&gt;&lt;/math&gt;" role="presentation" style="text-align: center; position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-136" style="width: 8.322em; display: inline-block;"><span style="display: inline-block; position: relative; width: 6.486em; height: 0px; font-size: 128%;"><span style="position: absolute; clip: rect(0.627em, 1006.45em, 3.088em, -999.998em); top: -2.264em; left: 0em;"><span class="mrow" id="MathJax-Span-137"><span class="msubsup" id="MathJax-Span-138"><span style="display: inline-block; position: relative; width: 1.096em; height: 0px;"><span style="position: absolute; clip: rect(3.439em, 1000.51em, 4.104em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-139" style="font-family: MathJax_Math-italic;">a</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -3.826em; left: 0.549em;"><span class="mi" id="MathJax-Span-140" style="font-size: 70.7%; font-family: MathJax_Math-italic;">L</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span class="mo" id="MathJax-Span-141" style="font-family: MathJax_Main; padding-left: 0.275em;">=</span><span class="mfrac" id="MathJax-Span-142" style="padding-left: 0.275em;"><span style="display: inline-block; position: relative; width: 1.018em; height: 0px; margin-right: 0.119em; margin-left: 0.119em;"><span style="position: absolute; clip: rect(3.049em, 1000.9em, 4.104em, -999.998em); top: -4.646em; left: 50%; margin-left: -0.467em;"><span class="msubsup" id="MathJax-Span-143"><span style="display: inline-block; position: relative; width: 0.9em; height: 0px;"><span style="position: absolute; clip: rect(3.439em, 1000.47em, 4.104em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-144" style="font-family: MathJax_Math-italic;">v</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -4.334em; left: 0.471em;"><span class="mn" id="MathJax-Span-145" style="font-size: 70.7%; font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; clip: rect(3.439em, 1000.43em, 4.104em, -999.998em); top: -3.279em; left: 50%; margin-left: -0.232em;"><span class="mi" id="MathJax-Span-146" style="font-family: MathJax_Math-italic;">r</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; clip: rect(0.861em, 1001.02em, 1.174em, -999.998em); top: -1.287em; left: 0em;"><span style="display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.5px solid; width: 1.018em; height: 0px;"></span><span style="display: inline-block; width: 0px; height: 1.057em;"></span></span></span></span><span class="mo" id="MathJax-Span-147" style="font-family: MathJax_Main; padding-left: 0.275em;">=</span><span class="msubsup" id="MathJax-Span-148" style="padding-left: 0.275em;"><span style="display: inline-block; position: relative; width: 0.9em; height: 0px;"><span style="position: absolute; clip: rect(3.439em, 1000.47em, 4.104em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-149" style="font-family: MathJax_Math-italic;">v</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -4.412em; left: 0.471em;"><span class="mn" id="MathJax-Span-150" style="font-size: 70.7%; font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span class="mi" id="MathJax-Span-151" style="font-family: MathJax_Math-italic;">κ</span></span><span style="display: inline-block; width: 0px; height: 2.268em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.948em; border-left: 0px solid; width: 0px; height: 2.952em;"></span></span></nobr><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><msub><mi>a</mi><mi>L</mi></msub><mo>=</mo><mfrac><msup><mi>v</mi><mn>2</mn></msup><mi>r</mi></mfrac><mo>=</mo><msup><mi>v</mi><mn>2</mn></msup><mi>κ</mi></math></span></span></div><script type="math/tex; mode=display" id="MathJax-Element-5">a_L = \frac{v^2}{r} = v^2 \kappa</script>

<span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_Display" style="text-align: center;"><span class="MathJax" id="MathJax-Element-6-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;&gt;&lt;msub&gt;&lt;mi&gt;v&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;M&lt;/mi&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;x&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;msqrt&gt;&lt;mrow&gt;&lt;mo&gt;|&lt;/mo&gt;&lt;mfrac&gt;&lt;msub&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;L&lt;/mi&gt;&lt;mi&gt;M&lt;/mi&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;x&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;mi&gt;&amp;#x03BA;&lt;/mi&gt;&lt;/mfrac&gt;&lt;mo&gt;|&lt;/mo&gt;&lt;/mrow&gt;&lt;/msqrt&gt;&lt;/math&gt;" role="presentation" style="text-align: center; position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-152" style="width: 10.158em; display: inline-block;"><span style="display: inline-block; position: relative; width: 7.932em; height: 0px; font-size: 128%;"><span style="position: absolute; clip: rect(0.705em, 1007.93em, 3.361em, -999.998em); top: -2.264em; left: 0em;"><span class="mrow" id="MathJax-Span-153"><span class="msubsup" id="MathJax-Span-154"><span style="display: inline-block; position: relative; width: 2.072em; height: 0px;"><span style="position: absolute; clip: rect(3.439em, 1000.47em, 4.104em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-155" style="font-family: MathJax_Math-italic;">v</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -3.826em; left: 0.471em;"><span class="texatom" id="MathJax-Span-156"><span class="mrow" id="MathJax-Span-157"><span class="mi" id="MathJax-Span-158" style="font-size: 70.7%; font-family: MathJax_Math-italic;">M<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.041em;"></span></span><span class="mi" id="MathJax-Span-159" style="font-size: 70.7%; font-family: MathJax_Math-italic;">a</span><span class="mi" id="MathJax-Span-160" style="font-size: 70.7%; font-family: MathJax_Math-italic;">x</span></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span class="mo" id="MathJax-Span-161" style="font-family: MathJax_Main; padding-left: 0.275em;">=</span><span class="msqrt" id="MathJax-Span-162" style="padding-left: 0.275em;"><span style="display: inline-block; position: relative; width: 4.533em; height: 0px;"><span style="position: absolute; clip: rect(2.658em, 1003.4em, 4.807em, -999.998em); top: -3.982em; left: 1.018em;"><span class="mrow" id="MathJax-Span-163"><span class="mrow" id="MathJax-Span-164"><span class="mo" id="MathJax-Span-165" style="vertical-align: 1.213em;"><span style="display: inline-block; position: relative; width: 0.275em; height: 0px;"><span style="position: absolute; font-family: MathJax_Main; top: -3.24em; left: 0em;">∣<span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; font-family: MathJax_Main; top: -2.342em; left: 0em;">∣<span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span class="mfrac" id="MathJax-Span-166"><span style="display: inline-block; position: relative; width: 2.736em; height: 0px; margin-right: 0.119em; margin-left: 0.119em;"><span style="position: absolute; clip: rect(3.439em, 1002.62em, 4.26em, -999.998em); top: -4.646em; left: 50%; margin-left: -1.287em;"><span class="msubsup" id="MathJax-Span-167"><span style="display: inline-block; position: relative; width: 2.619em; height: 0px;"><span style="position: absolute; clip: rect(3.439em, 1000.51em, 4.104em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-168" style="font-family: MathJax_Math-italic;">a</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -3.826em; left: 0.549em;"><span class="texatom" id="MathJax-Span-169"><span class="mrow" id="MathJax-Span-170"><span class="mi" id="MathJax-Span-171" style="font-size: 70.7%; font-family: MathJax_Math-italic;">L</span><span class="mi" id="MathJax-Span-172" style="font-size: 70.7%; font-family: MathJax_Math-italic;">M<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.041em;"></span></span><span class="mi" id="MathJax-Span-173" style="font-size: 70.7%; font-family: MathJax_Math-italic;">a</span><span class="mi" id="MathJax-Span-174" style="font-size: 70.7%; font-family: MathJax_Math-italic;">x</span></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; clip: rect(3.439em, 1000.55em, 4.104em, -999.998em); top: -3.279em; left: 50%; margin-left: -0.271em;"><span class="mi" id="MathJax-Span-175" style="font-family: MathJax_Math-italic;">κ</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; clip: rect(0.861em, 1002.74em, 1.174em, -999.998em); top: -1.287em; left: 0em;"><span style="display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.5px solid; width: 2.736em; height: 0px;"></span><span style="display: inline-block; width: 0px; height: 1.057em;"></span></span></span></span><span class="mo" id="MathJax-Span-176" style="vertical-align: 1.213em;"><span style="display: inline-block; position: relative; width: 0.275em; height: 0px;"><span style="position: absolute; font-family: MathJax_Main; top: -3.24em; left: 0em;">∣<span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; font-family: MathJax_Main; top: -2.342em; left: 0em;">∣<span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; clip: rect(3.596em, 1003.56em, 3.869em, -999.998em); top: -5.115em; left: 1.018em;"><span style="display: inline-block; position: relative; width: 3.557em; height: 0px;"><span style="position: absolute; font-family: MathJax_Main; top: -3.982em; left: -0.076em;">−<span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; font-family: MathJax_Main; top: -3.982em; left: 2.854em;">−<span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -3.982em; left: 0.393em;">−<span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -3.982em; left: 0.861em;">−<span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -3.982em; left: 1.369em;">−<span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -3.982em; left: 1.877em;">−<span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -3.982em; left: 2.346em;">−<span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; clip: rect(2.424em, 1001.02em, 5.041em, -999.998em); top: -3.943em; left: 0em;"><span style="font-family: MathJax_Size3;">√</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.268em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -1.297em; border-left: 0px solid; width: 0px; height: 3.152em;"></span></span></nobr><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><msub><mi>v</mi><mrow class="MJX-TeXAtom-ORD"><mi>M</mi><mi>a</mi><mi>x</mi></mrow></msub><mo>=</mo><msqrt><mrow><mo>|</mo><mfrac><msub><mi>a</mi><mrow class="MJX-TeXAtom-ORD"><mi>L</mi><mi>M</mi><mi>a</mi><mi>x</mi></mrow></msub><mi>κ</mi></mfrac><mo>|</mo></mrow></msqrt></math></span></span></div><script type="math/tex; mode=display" id="MathJax-Element-6">v_{Max} = \sqrt{\left|\frac{a_{LMax}}{\kappa}\right|}</script>

<p>There are some minor practicalities to consider here (<span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-7-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;&amp;#x03BA;&lt;/mi&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-177" style="width: 0.783em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.588em; height: 0px; font-size: 128%;"><span style="position: absolute; clip: rect(1.721em, 1000.55em, 2.385em, -999.998em); top: -2.264em; left: 0em;"><span class="mrow" id="MathJax-Span-178"><span class="mi" id="MathJax-Span-179" style="font-family: MathJax_Math-italic;">κ</span></span><span style="display: inline-block; width: 0px; height: 2.268em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.048em; border-left: 0px solid; width: 0px; height: 0.703em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>κ</mi></math></span></span><script type="math/tex" id="MathJax-Element-7">\kappa</script> can be near
zero) – I compute <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-8-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;msub&gt;&lt;mi&gt;&amp;#x03BA;&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;m&lt;/mi&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;L&lt;/mi&gt;&lt;mi&gt;m&lt;/mi&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;x&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mo&gt;/&lt;/mo&gt;&lt;/mrow&gt;&lt;msubsup&gt;&lt;mi&gt;v&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;m&lt;/mi&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;x&lt;/mi&gt;&lt;/mrow&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/msubsup&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-180" style="width: 10.549em; display: inline-block;"><span style="display: inline-block; position: relative; width: 8.244em; height: 0px; font-size: 128%;"><span style="position: absolute; clip: rect(1.33em, 1008.24em, 2.619em, -999.998em); top: -2.264em; left: 0em;"><span class="mrow" id="MathJax-Span-181"><span class="msubsup" id="MathJax-Span-182"><span style="display: inline-block; position: relative; width: 1.955em; height: 0px;"><span style="position: absolute; clip: rect(3.439em, 1000.55em, 4.104em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-183" style="font-family: MathJax_Math-italic;">κ</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -3.826em; left: 0.588em;"><span class="texatom" id="MathJax-Span-184"><span class="mrow" id="MathJax-Span-185"><span class="mi" id="MathJax-Span-186" style="font-size: 70.7%; font-family: MathJax_Math-italic;">m</span><span class="mi" id="MathJax-Span-187" style="font-size: 70.7%; font-family: MathJax_Math-italic;">i</span><span class="mi" id="MathJax-Span-188" style="font-size: 70.7%; font-family: MathJax_Math-italic;">n</span></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span class="mo" id="MathJax-Span-189" style="font-family: MathJax_Main; padding-left: 0.275em;">=</span><span class="msubsup" id="MathJax-Span-190" style="padding-left: 0.275em;"><span style="display: inline-block; position: relative; width: 2.502em; height: 0px;"><span style="position: absolute; clip: rect(3.439em, 1000.51em, 4.104em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-191" style="font-family: MathJax_Math-italic;">a</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -3.826em; left: 0.549em;"><span class="texatom" id="MathJax-Span-192"><span class="mrow" id="MathJax-Span-193"><span class="mi" id="MathJax-Span-194" style="font-size: 70.7%; font-family: MathJax_Math-italic;">L</span><span class="mi" id="MathJax-Span-195" style="font-size: 70.7%; font-family: MathJax_Math-italic;">m</span><span class="mi" id="MathJax-Span-196" style="font-size: 70.7%; font-family: MathJax_Math-italic;">a</span><span class="mi" id="MathJax-Span-197" style="font-size: 70.7%; font-family: MathJax_Math-italic;">x</span></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span class="texatom" id="MathJax-Span-198"><span class="mrow" id="MathJax-Span-199"><span class="mo" id="MathJax-Span-200" style="font-family: MathJax_Main;">/</span></span></span><span class="msubsup" id="MathJax-Span-201"><span style="display: inline-block; position: relative; width: 1.955em; height: 0px;"><span style="position: absolute; clip: rect(3.439em, 1000.47em, 4.104em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-202" style="font-family: MathJax_Math-italic;">v</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; clip: rect(3.4em, 1000.43em, 4.104em, -999.998em); top: -4.334em; left: 0.471em;"><span class="mn" id="MathJax-Span-203" style="font-size: 70.7%; font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; clip: rect(3.557em, 1001.49em, 4.104em, -999.998em); top: -3.826em; left: 0.471em;"><span class="texatom" id="MathJax-Span-204"><span class="mrow" id="MathJax-Span-205"><span class="mi" id="MathJax-Span-206" style="font-size: 70.7%; font-family: MathJax_Math-italic;">m</span><span class="mi" id="MathJax-Span-207" style="font-size: 70.7%; font-family: MathJax_Math-italic;">a</span><span class="mi" id="MathJax-Span-208" style="font-size: 70.7%; font-family: MathJax_Math-italic;">x</span></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.268em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.348em; border-left: 0px solid; width: 0px; height: 1.453em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>κ</mi><mrow class="MJX-TeXAtom-ORD"><mi>m</mi><mi>i</mi><mi>n</mi></mrow></msub><mo>=</mo><msub><mi>a</mi><mrow class="MJX-TeXAtom-ORD"><mi>L</mi><mi>m</mi><mi>a</mi><mi>x</mi></mrow></msub><mrow class="MJX-TeXAtom-ORD"><mo>/</mo></mrow><msubsup><mi>v</mi><mrow class="MJX-TeXAtom-ORD"><mi>m</mi><mi>a</mi><mi>x</mi></mrow><mn>2</mn></msubsup></math></span></span><script type="math/tex" id="MathJax-Element-8">\kappa_{min} = a_{Lmax} / v_{max}^2</script> and set <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-9-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;v&lt;/mi&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;v&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;m&lt;/mi&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;x&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-209" style="width: 4.807em; display: inline-block;"><span style="display: inline-block; position: relative; width: 3.752em; height: 0px; font-size: 128%;"><span style="position: absolute; clip: rect(1.721em, 1003.75em, 2.541em, -999.998em); top: -2.264em; left: 0em;"><span class="mrow" id="MathJax-Span-210"><span class="mi" id="MathJax-Span-211" style="font-family: MathJax_Math-italic;">v</span><span class="mo" id="MathJax-Span-212" style="font-family: MathJax_Main; padding-left: 0.275em;">=</span><span class="msubsup" id="MathJax-Span-213" style="padding-left: 0.275em;"><span style="display: inline-block; position: relative; width: 1.955em; height: 0px;"><span style="position: absolute; clip: rect(3.439em, 1000.47em, 4.104em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-214" style="font-family: MathJax_Math-italic;">v</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -3.826em; left: 0.471em;"><span class="texatom" id="MathJax-Span-215"><span class="mrow" id="MathJax-Span-216"><span class="mi" id="MathJax-Span-217" style="font-size: 70.7%; font-family: MathJax_Math-italic;">m</span><span class="mi" id="MathJax-Span-218" style="font-size: 70.7%; font-family: MathJax_Math-italic;">a</span><span class="mi" id="MathJax-Span-219" style="font-size: 70.7%; font-family: MathJax_Math-italic;">x</span></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.268em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 0.853em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>v</mi><mo>=</mo><msub><mi>v</mi><mrow class="MJX-TeXAtom-ORD"><mi>m</mi><mi>a</mi><mi>x</mi></mrow></msub></math></span></span><script type="math/tex" id="MathJax-Element-9">v = v_{max}</script> if <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-10-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mrow&gt;&lt;mo&gt;|&lt;/mo&gt;&lt;mi&gt;&amp;#x03BA;&lt;/mi&gt;&lt;mo&gt;|&lt;/mo&gt;&lt;/mrow&gt;&lt;mo&gt;&amp;lt;&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;&amp;#x03BA;&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;m&lt;/mi&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-220" style="width: 5.666em; display: inline-block;"><span style="display: inline-block; position: relative; width: 4.416em; height: 0px; font-size: 128%;"><span style="position: absolute; clip: rect(1.408em, 1004.42em, 2.619em, -999.998em); top: -2.264em; left: 0em;"><span class="mrow" id="MathJax-Span-221"><span class="mrow" id="MathJax-Span-222"><span class="mo" id="MathJax-Span-223" style="font-family: MathJax_Main;">|</span><span class="mi" id="MathJax-Span-224" style="font-family: MathJax_Math-italic;">κ</span><span class="mo" id="MathJax-Span-225" style="font-family: MathJax_Main;">|</span></span><span class="mo" id="MathJax-Span-226" style="font-family: MathJax_Main; padding-left: 0.275em;">&lt;</span><span class="msubsup" id="MathJax-Span-227" style="padding-left: 0.275em;"><span style="display: inline-block; position: relative; width: 1.955em; height: 0px;"><span style="position: absolute; clip: rect(3.439em, 1000.55em, 4.104em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-228" style="font-family: MathJax_Math-italic;">κ</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -3.826em; left: 0.588em;"><span class="texatom" id="MathJax-Span-229"><span class="mrow" id="MathJax-Span-230"><span class="mi" id="MathJax-Span-231" style="font-size: 70.7%; font-family: MathJax_Math-italic;">m</span><span class="mi" id="MathJax-Span-232" style="font-size: 70.7%; font-family: MathJax_Math-italic;">i</span><span class="mi" id="MathJax-Span-233" style="font-size: 70.7%; font-family: MathJax_Math-italic;">n</span></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.268em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.348em; border-left: 0px solid; width: 0px; height: 1.403em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow><mo>|</mo><mi>κ</mi><mo>|</mo></mrow><mo>&lt;</mo><msub><mi>κ</mi><mrow class="MJX-TeXAtom-ORD"><mi>m</mi><mi>i</mi><mi>n</mi></mrow></msub></math></span></span><script type="math/tex" id="MathJax-Element-10">% <![CDATA[
\left|\kappa\right| < \kappa_{min} %]]></script>.</p>

<div class="container-fluid">
<canvas class="linefollower control-rr2097" width="400" height="200"></canvas>
</div>
<fieldset>
<div>
  <label for="Kp">Kp</label><input type="range" name="Kp" min="0.1" max="3" value="1" step="0.1" class="control-rr2097v" style="width: 90%; float: right; margin: auto;">
</div>
<div>
  <label for="Kd">Kd</label><input type="range" name="Kd" min="0.1" max="10" value="1" step="0.1" class="control-rr2097v" style="width: 90%; float: right; margin: auto;">
</div>
<div>
  <label for="aL">a<sub>L</sub></label><input type="range" name="aL" min="0.1" max="20" value="6" step="0.5" class="control-rr2097v" style="width: 90%; float: right; margin: auto;">
</div>
<div>
  <label for="vmax">v<sub>max</sub></label><input type="range" name="vmax" min="0.1" max="20" value="10" step="0.5" class="control-rr2097v" style="width: 90%; float: right; margin: auto;">
</div>
<div>
  <label for="lookahead">lookahead</label><input type="range" name="lookahead" min="0" max="20" value="10" step="1" class="control-rr2097v" style="width: 90%; float: right; margin: auto;">
</div>
</fieldset>

<span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_Display" style="text-align: center;"><span class="MathJax" id="MathJax-Element-11-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;&gt;&lt;msup&gt;&lt;mi&gt;&amp;#x03BA;&lt;/mi&gt;&lt;mo&gt;&amp;#x2032;&lt;/mo&gt;&lt;/msup&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mfrac&gt;&lt;mrow&gt;&lt;mi&gt;cos&lt;/mi&gt;&lt;mo&gt;&amp;#x2061;&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;&amp;#x03C8;&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;/msub&gt;&lt;/mrow&gt;&lt;mrow&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;mi&gt;&amp;#x03BA;&lt;/mi&gt;&lt;msub&gt;&lt;mi&gt;y&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;/msub&gt;&lt;/mrow&gt;&lt;/mfrac&gt;&lt;mrow&gt;&lt;mo&gt;[&lt;/mo&gt;&lt;mrow&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;K&lt;/mi&gt;&lt;mi&gt;p&lt;/mi&gt;&lt;/msub&gt;&lt;mfrac&gt;&lt;mrow&gt;&lt;msub&gt;&lt;mi&gt;y&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;/msub&gt;&lt;msup&gt;&lt;mi&gt;cos&lt;/mi&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/msup&gt;&lt;mo&gt;&amp;#x2061;&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;&amp;#x03C8;&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;/msub&gt;&lt;/mrow&gt;&lt;mrow&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;mi&gt;&amp;#x03BA;&lt;/mi&gt;&lt;msub&gt;&lt;mi&gt;y&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;/msub&gt;&lt;/mrow&gt;&lt;/mfrac&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;mi&gt;sin&lt;/mi&gt;&lt;mo&gt;&amp;#x2061;&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;&amp;#x03C8;&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;/msub&gt;&lt;mrow&gt;&lt;mo&gt;(&lt;/mo&gt;&lt;mrow&gt;&lt;mi&gt;&amp;#x03BA;&lt;/mi&gt;&lt;mi&gt;sin&lt;/mi&gt;&lt;mo&gt;&amp;#x2061;&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;&amp;#x03C8;&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;/msub&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;K&lt;/mi&gt;&lt;mi&gt;d&lt;/mi&gt;&lt;/msub&gt;&lt;mi&gt;cos&lt;/mi&gt;&lt;mo&gt;&amp;#x2061;&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;&amp;#x03C8;&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;/msub&gt;&lt;/mrow&gt;&lt;mo&gt;)&lt;/mo&gt;&lt;/mrow&gt;&lt;/mrow&gt;&lt;mo&gt;]&lt;/mo&gt;&lt;/mrow&gt;&lt;/math&gt;" role="presentation" style="text-align: center; position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-234" style="width: 33.713em; display: inline-block;"><span style="display: inline-block; position: relative; width: 26.33em; height: 0px; font-size: 128%;"><span style="position: absolute; clip: rect(1.76em, 1026.1em, 4.455em, -999.998em); top: -3.396em; left: 0em;"><span class="mrow" id="MathJax-Span-235"><span class="msup" id="MathJax-Span-236"><span style="display: inline-block; position: relative; width: 0.861em; height: 0px;"><span style="position: absolute; clip: rect(3.439em, 1000.55em, 4.104em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-237" style="font-family: MathJax_Math-italic;">κ</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -4.412em; left: 0.588em;"><span class="mo" id="MathJax-Span-238" style="font-size: 70.7%; font-family: MathJax_Main;">′</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span class="mo" id="MathJax-Span-239" style="font-family: MathJax_Main; padding-left: 0.275em;">=</span><span class="mfrac" id="MathJax-Span-240" style="padding-left: 0.275em;"><span style="display: inline-block; position: relative; width: 3.361em; height: 0px; margin-right: 0.119em; margin-left: 0.119em;"><span style="position: absolute; clip: rect(3.166em, 1002.54em, 4.299em, -999.998em); top: -4.646em; left: 50%; margin-left: -1.287em;"><span class="mrow" id="MathJax-Span-241"><span class="mi" id="MathJax-Span-242" style="font-family: MathJax_Main;">cos</span><span class="mo" id="MathJax-Span-243"></span><span class="msubsup" id="MathJax-Span-244" style="padding-left: 0.158em;"><span style="display: inline-block; position: relative; width: 1.057em; height: 0px;"><span style="position: absolute; clip: rect(3.166em, 1000.63em, 4.299em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-245" style="font-family: MathJax_Math-italic;">ψ</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -3.826em; left: 0.666em;"><span class="mi" id="MathJax-Span-246" style="font-size: 70.7%; font-family: MathJax_Math-italic;">e</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; clip: rect(3.205em, 1003.21em, 4.299em, -999.998em); top: -3.279em; left: 50%; margin-left: -1.6em;"><span class="mrow" id="MathJax-Span-247"><span class="mn" id="MathJax-Span-248" style="font-family: MathJax_Main;">1</span><span class="mo" id="MathJax-Span-249" style="font-family: MathJax_Main; padding-left: 0.236em;">−</span><span class="mi" id="MathJax-Span-250" style="font-family: MathJax_Math-italic; padding-left: 0.236em;">κ</span><span class="msubsup" id="MathJax-Span-251"><span style="display: inline-block; position: relative; width: 0.9em; height: 0px;"><span style="position: absolute; clip: rect(3.439em, 1000.51em, 4.299em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-252" style="font-family: MathJax_Math-italic;">y<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -3.826em; left: 0.51em;"><span class="mi" id="MathJax-Span-253" style="font-size: 70.7%; font-family: MathJax_Math-italic;">e</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; clip: rect(0.861em, 1003.36em, 1.174em, -999.998em); top: -1.287em; left: 0em;"><span style="display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.5px solid; width: 3.361em; height: 0px;"></span><span style="display: inline-block; width: 0px; height: 1.057em;"></span></span></span></span><span class="mrow" id="MathJax-Span-254"><span class="mo" id="MathJax-Span-255" style="vertical-align: 0em;"><span style="font-family: MathJax_Size3;">[</span></span><span class="mrow" id="MathJax-Span-256"><span class="mo" id="MathJax-Span-257" style="font-family: MathJax_Main;">−</span><span class="msubsup" id="MathJax-Span-258"><span style="display: inline-block; position: relative; width: 1.291em; height: 0px;"><span style="position: absolute; clip: rect(3.205em, 1000.9em, 4.104em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-259" style="font-family: MathJax_Math-italic;">K<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.041em;"></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -3.826em; left: 0.861em;"><span class="mi" id="MathJax-Span-260" style="font-size: 70.7%; font-family: MathJax_Math-italic;">p</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span class="mfrac" id="MathJax-Span-261"><span style="display: inline-block; position: relative; width: 4.143em; height: 0px; margin-right: 0.119em; margin-left: 0.119em;"><span style="position: absolute; clip: rect(3.049em, 1004.02em, 4.299em, -999.998em); top: -4.646em; left: 50%; margin-left: -2.029em;"><span class="mrow" id="MathJax-Span-262"><span class="msubsup" id="MathJax-Span-263"><span style="display: inline-block; position: relative; width: 0.9em; height: 0px;"><span style="position: absolute; clip: rect(3.439em, 1000.51em, 4.299em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-264" style="font-family: MathJax_Math-italic;">y<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -3.826em; left: 0.51em;"><span class="mi" id="MathJax-Span-265" style="font-size: 70.7%; font-family: MathJax_Math-italic;">e</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span class="msubsup" id="MathJax-Span-266" style="padding-left: 0.158em;"><span style="display: inline-block; position: relative; width: 1.76em; height: 0px;"><span style="position: absolute; clip: rect(3.439em, 1001.29em, 4.104em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-267" style="font-family: MathJax_Main;">cos</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -4.334em; left: 1.33em;"><span class="mn" id="MathJax-Span-268" style="font-size: 70.7%; font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span class="mo" id="MathJax-Span-269"></span><span class="msubsup" id="MathJax-Span-270" style="padding-left: 0.158em;"><span style="display: inline-block; position: relative; width: 1.057em; height: 0px;"><span style="position: absolute; clip: rect(3.166em, 1000.63em, 4.299em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-271" style="font-family: MathJax_Math-italic;">ψ</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -3.826em; left: 0.666em;"><span class="mi" id="MathJax-Span-272" style="font-size: 70.7%; font-family: MathJax_Math-italic;">e</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; clip: rect(3.205em, 1003.21em, 4.299em, -999.998em); top: -3.279em; left: 50%; margin-left: -1.6em;"><span class="mrow" id="MathJax-Span-273"><span class="mn" id="MathJax-Span-274" style="font-family: MathJax_Main;">1</span><span class="mo" id="MathJax-Span-275" style="font-family: MathJax_Main; padding-left: 0.236em;">−</span><span class="mi" id="MathJax-Span-276" style="font-family: MathJax_Math-italic; padding-left: 0.236em;">κ</span><span class="msubsup" id="MathJax-Span-277"><span style="display: inline-block; position: relative; width: 0.9em; height: 0px;"><span style="position: absolute; clip: rect(3.439em, 1000.51em, 4.299em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-278" style="font-family: MathJax_Math-italic;">y<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -3.826em; left: 0.51em;"><span class="mi" id="MathJax-Span-279" style="font-size: 70.7%; font-family: MathJax_Math-italic;">e</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; clip: rect(0.861em, 1004.14em, 1.174em, -999.998em); top: -1.287em; left: 0em;"><span style="display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.5px solid; width: 4.143em; height: 0px;"></span><span style="display: inline-block; width: 0px; height: 1.057em;"></span></span></span></span><span class="mo" id="MathJax-Span-280" style="font-family: MathJax_Main; padding-left: 0.236em;">+</span><span class="mi" id="MathJax-Span-281" style="font-family: MathJax_Main; padding-left: 0.236em;">sin</span><span class="mo" id="MathJax-Span-282"></span><span class="msubsup" id="MathJax-Span-283" style="padding-left: 0.158em;"><span style="display: inline-block; position: relative; width: 1.057em; height: 0px;"><span style="position: absolute; clip: rect(3.166em, 1000.63em, 4.299em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-284" style="font-family: MathJax_Math-italic;">ψ</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -3.826em; left: 0.666em;"><span class="mi" id="MathJax-Span-285" style="font-size: 70.7%; font-family: MathJax_Math-italic;">e</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span class="mrow" id="MathJax-Span-286" style="padding-left: 0.158em;"><span class="mo" id="MathJax-Span-287" style="font-family: MathJax_Main;">(</span><span class="mrow" id="MathJax-Span-288"><span class="mi" id="MathJax-Span-289" style="font-family: MathJax_Math-italic;">κ</span><span class="mi" id="MathJax-Span-290" style="font-family: MathJax_Main; padding-left: 0.158em;">sin</span><span class="mo" id="MathJax-Span-291"></span><span class="msubsup" id="MathJax-Span-292" style="padding-left: 0.158em;"><span style="display: inline-block; position: relative; width: 1.057em; height: 0px;"><span style="position: absolute; clip: rect(3.166em, 1000.63em, 4.299em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-293" style="font-family: MathJax_Math-italic;">ψ</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -3.826em; left: 0.666em;"><span class="mi" id="MathJax-Span-294" style="font-size: 70.7%; font-family: MathJax_Math-italic;">e</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span class="mo" id="MathJax-Span-295" style="font-family: MathJax_Main; padding-left: 0.236em;">−</span><span class="msubsup" id="MathJax-Span-296" style="padding-left: 0.236em;"><span style="display: inline-block; position: relative; width: 1.291em; height: 0px;"><span style="position: absolute; clip: rect(3.205em, 1000.9em, 4.104em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-297" style="font-family: MathJax_Math-italic;">K<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.041em;"></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -3.826em; left: 0.861em;"><span class="mi" id="MathJax-Span-298" style="font-size: 70.7%; font-family: MathJax_Math-italic;">d<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.002em;"></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span class="mi" id="MathJax-Span-299" style="font-family: MathJax_Main; padding-left: 0.158em;">cos</span><span class="mo" id="MathJax-Span-300"></span><span class="msubsup" id="MathJax-Span-301" style="padding-left: 0.158em;"><span style="display: inline-block; position: relative; width: 1.057em; height: 0px;"><span style="position: absolute; clip: rect(3.166em, 1000.63em, 4.299em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-302" style="font-family: MathJax_Math-italic;">ψ</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -3.826em; left: 0.666em;"><span class="mi" id="MathJax-Span-303" style="font-size: 70.7%; font-family: MathJax_Math-italic;">e</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span></span><span class="mo" id="MathJax-Span-304" style="font-family: MathJax_Main;">)</span></span></span><span class="mo" id="MathJax-Span-305" style="vertical-align: 0em;"><span style="font-family: MathJax_Size3;">]</span></span></span></span><span style="display: inline-block; width: 0px; height: 3.4em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -1.248em; border-left: 0px solid; width: 0px; height: 3.252em;"></span></span></nobr><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><msup><mi>κ</mi><mo>′</mo></msup><mo>=</mo><mfrac><mrow><mi>cos</mi><mo>⁡</mo><msub><mi>ψ</mi><mi>e</mi></msub></mrow><mrow><mn>1</mn><mo>−</mo><mi>κ</mi><msub><mi>y</mi><mi>e</mi></msub></mrow></mfrac><mrow><mo>[</mo><mrow><mo>−</mo><msub><mi>K</mi><mi>p</mi></msub><mfrac><mrow><msub><mi>y</mi><mi>e</mi></msub><msup><mi>cos</mi><mn>2</mn></msup><mo>⁡</mo><msub><mi>ψ</mi><mi>e</mi></msub></mrow><mrow><mn>1</mn><mo>−</mo><mi>κ</mi><msub><mi>y</mi><mi>e</mi></msub></mrow></mfrac><mo>+</mo><mi>sin</mi><mo>⁡</mo><msub><mi>ψ</mi><mi>e</mi></msub><mrow><mo>(</mo><mrow><mi>κ</mi><mi>sin</mi><mo>⁡</mo><msub><mi>ψ</mi><mi>e</mi></msub><mo>−</mo><msub><mi>K</mi><mi>d</mi></msub><mi>cos</mi><mo>⁡</mo><msub><mi>ψ</mi><mi>e</mi></msub></mrow><mo>)</mo></mrow></mrow><mo>]</mo></mrow></math></span></span></div><script type="math/tex; mode=display" id="MathJax-Element-11">\kappa' = \frac{\cos \psi_e}{1 - \kappa y_e}\left[ -K_p \frac{y_e \cos^2 \psi_e}{1 - \kappa y_e} + \sin \psi_e \left(\kappa \sin \psi_e - K_d \cos \psi_e \right) \right]</script>

<span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_Display" style="text-align: center;"><span class="MathJax" id="MathJax-Element-12-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;&gt;&lt;mi&gt;v&lt;/mi&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mo movablelimits=&quot;true&quot; form=&quot;prefix&quot;&gt;min&lt;/mo&gt;&lt;mrow&gt;&lt;mo&gt;(&lt;/mo&gt;&lt;mrow&gt;&lt;msqrt&gt;&lt;mrow&gt;&lt;mo&gt;|&lt;/mo&gt;&lt;mfrac&gt;&lt;msub&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;L&lt;/mi&gt;&lt;/msub&gt;&lt;msup&gt;&lt;mi&gt;&amp;#x03BA;&lt;/mi&gt;&lt;mo&gt;&amp;#x2032;&lt;/mo&gt;&lt;/msup&gt;&lt;/mfrac&gt;&lt;mo&gt;|&lt;/mo&gt;&lt;/mrow&gt;&lt;/msqrt&gt;&lt;mo&gt;,&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;v&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;m&lt;/mi&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;x&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;/mrow&gt;&lt;mo&gt;)&lt;/mo&gt;&lt;/mrow&gt;&lt;/math&gt;" role="presentation" style="text-align: center; position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-306" style="width: 13.479em; display: inline-block;"><span style="display: inline-block; position: relative; width: 10.51em; height: 0px; font-size: 128%;"><span style="position: absolute; clip: rect(1.838em, 1010.31em, 4.494em, -999.998em); top: -3.396em; left: 0em;"><span class="mrow" id="MathJax-Span-307"><span class="mi" id="MathJax-Span-308" style="font-family: MathJax_Math-italic;">v</span><span class="mo" id="MathJax-Span-309" style="font-family: MathJax_Main; padding-left: 0.275em;">=</span><span class="mo" id="MathJax-Span-310" style="font-family: MathJax_Main; padding-left: 0.275em;">min</span><span class="mrow" id="MathJax-Span-311" style="padding-left: 0.158em;"><span class="mo" id="MathJax-Span-312" style="vertical-align: 0em;"><span style="font-family: MathJax_Size3;">(</span></span><span class="mrow" id="MathJax-Span-313"><span class="msqrt" id="MathJax-Span-314"><span style="display: inline-block; position: relative; width: 3.01em; height: 0px;"><span style="position: absolute; clip: rect(2.658em, 1001.88em, 4.807em, -999.998em); top: -3.982em; left: 1.018em;"><span class="mrow" id="MathJax-Span-315"><span class="mrow" id="MathJax-Span-316"><span class="mo" id="MathJax-Span-317" style="vertical-align: 1.213em;"><span style="display: inline-block; position: relative; width: 0.275em; height: 0px;"><span style="position: absolute; font-family: MathJax_Main; top: -3.24em; left: 0em;">∣<span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; font-family: MathJax_Main; top: -2.342em; left: 0em;">∣<span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span class="mfrac" id="MathJax-Span-318"><span style="display: inline-block; position: relative; width: 1.213em; height: 0px; margin-right: 0.119em; margin-left: 0.119em;"><span style="position: absolute; clip: rect(3.439em, 1001.1em, 4.26em, -999.998em); top: -4.646em; left: 50%; margin-left: -0.545em;"><span class="msubsup" id="MathJax-Span-319"><span style="display: inline-block; position: relative; width: 1.096em; height: 0px;"><span style="position: absolute; clip: rect(3.439em, 1000.51em, 4.104em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-320" style="font-family: MathJax_Math-italic;">a</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -3.826em; left: 0.549em;"><span class="mi" id="MathJax-Span-321" style="font-size: 70.7%; font-family: MathJax_Math-italic;">L</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; clip: rect(3.166em, 1000.86em, 4.104em, -999.998em); top: -3.279em; left: 50%; margin-left: -0.428em;"><span class="msup" id="MathJax-Span-322"><span style="display: inline-block; position: relative; width: 0.861em; height: 0px;"><span style="position: absolute; clip: rect(3.439em, 1000.55em, 4.104em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-323" style="font-family: MathJax_Math-italic;">κ</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -4.256em; left: 0.588em;"><span class="mo" id="MathJax-Span-324" style="font-size: 70.7%; font-family: MathJax_Main;">′</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; clip: rect(0.861em, 1001.21em, 1.174em, -999.998em); top: -1.287em; left: 0em;"><span style="display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.5px solid; width: 1.213em; height: 0px;"></span><span style="display: inline-block; width: 0px; height: 1.057em;"></span></span></span></span><span class="mo" id="MathJax-Span-325" style="vertical-align: 1.213em;"><span style="display: inline-block; position: relative; width: 0.275em; height: 0px;"><span style="position: absolute; font-family: MathJax_Main; top: -3.24em; left: 0em;">∣<span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; font-family: MathJax_Main; top: -2.342em; left: 0em;">∣<span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; clip: rect(3.596em, 1002.03em, 3.869em, -999.998em); top: -5.115em; left: 1.018em;"><span style="display: inline-block; position: relative; width: 2.033em; height: 0px;"><span style="position: absolute; font-family: MathJax_Main; top: -3.982em; left: -0.076em;">−<span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; font-family: MathJax_Main; top: -3.982em; left: 1.33em;">−<span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -3.982em; left: 0.393em;">−<span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="font-family: MathJax_Main; position: absolute; top: -3.982em; left: 0.861em;">−<span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; clip: rect(2.424em, 1001.02em, 5.041em, -999.998em); top: -3.943em; left: 0em;"><span style="font-family: MathJax_Size3;">√</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span><span class="mo" id="MathJax-Span-326" style="font-family: MathJax_Main;">,</span><span class="msubsup" id="MathJax-Span-327" style="padding-left: 0.158em;"><span style="display: inline-block; position: relative; width: 1.955em; height: 0px;"><span style="position: absolute; clip: rect(3.439em, 1000.47em, 4.104em, -999.998em); top: -3.982em; left: 0em;"><span class="mi" id="MathJax-Span-328" style="font-family: MathJax_Math-italic;">v</span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span><span style="position: absolute; top: -3.826em; left: 0.471em;"><span class="texatom" id="MathJax-Span-329"><span class="mrow" id="MathJax-Span-330"><span class="mi" id="MathJax-Span-331" style="font-size: 70.7%; font-family: MathJax_Math-italic;">m</span><span class="mi" id="MathJax-Span-332" style="font-size: 70.7%; font-family: MathJax_Math-italic;">a</span><span class="mi" id="MathJax-Span-333" style="font-size: 70.7%; font-family: MathJax_Math-italic;">x</span></span></span><span style="display: inline-block; width: 0px; height: 3.986em;"></span></span></span></span></span><span class="mo" id="MathJax-Span-334" style="vertical-align: 0em;"><span style="font-family: MathJax_Size3;">)</span></span></span></span><span style="display: inline-block; width: 0px; height: 3.4em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -1.297em; border-left: 0px solid; width: 0px; height: 3.202em;"></span></span></nobr><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mi>v</mi><mo>=</mo><mo movablelimits="true" form="prefix">min</mo><mrow><mo>(</mo><mrow><msqrt><mrow><mo>|</mo><mfrac><msub><mi>a</mi><mi>L</mi></msub><msup><mi>κ</mi><mo>′</mo></msup></mfrac><mo>|</mo></mrow></msqrt><mo>,</mo><msub><mi>v</mi><mrow class="MJX-TeXAtom-ORD"><mi>m</mi><mi>a</mi><mi>x</mi></mrow></msub></mrow><mo>)</mo></mrow></math></span></span></div><script type="math/tex; mode=display" id="MathJax-Element-12">v = \min\left(\sqrt{\left|\frac{a_L}{\kappa'}\right|}, v_{max}\right)</script>

<p>Now it speeds up for straights and slows down for turns. The only problem is it
doesn’t have instantly-acting brakes, so it’s still surprised by turns; I’ve
added one more parameter which is how far it looks ahead before determining the
<span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-13-Frame" tabindex="0" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;&amp;#x03BA;&lt;/mi&gt;&lt;/math&gt;" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-335" style="width: 0.783em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.588em; height: 0px; font-size: 128%;"><span style="position: absolute; clip: rect(1.721em, 1000.55em, 2.385em, -999.998em); top: -2.264em; left: 0em;"><span class="mrow" id="MathJax-Span-336"><span class="mi" id="MathJax-Span-337" style="font-family: MathJax_Math-italic;">κ</span></span><span style="display: inline-block; width: 0px; height: 2.268em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.048em; border-left: 0px solid; width: 0px; height: 0.703em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>κ</mi></math></span></span><script type="math/tex" id="MathJax-Element-13">\kappa</script> to use to compute its velocity – it will look ahead on the track
and take the maximum of its control curvature and the curvature on the track
coming ahead to determine its speed limit.</p>

<h4 id="future-work">Future work</h4>

<p>At this point we’re reaching the limits of what we can do with simple PD-type
control, and to get really great tracking we need to start doing finite-horizon
planning, but that’s out of the scope of what I want to cover here. <a href="https://studywolf.wordpress.com/2016/02/03/the-iterative-linear-quadratic-regulator-method/">Iterated
Linear Quadratic Regulators / Differential Dynamic Programming</a> are what I
would use next, but we haven’t talked about even making the simple algorithms
practical yet!</p>

<h2 id="finding-y-ψ-κ-and-all-that">Finding <em>y</em>, <em>Ψ</em>, <em>κ</em>, and all that</h2>

<p>In a real robot, we need to use our sensors to make measurements of the line
with respect to our own position / orientation. This can be as simple as some
phototransistors pointing at the ground, or a front-facing (preferably
wide-angle) camera.</p>

<p>Either way, we can at least indirectly measure these parameters. To track them
over time and refine our estimates requires a Kalman filter, which I will cover
in my next post.</p>

<p>For now, this is a very brief overview of how it was done in the first video above:</p>

<ul>
  <li>Calibrate the camera with OpenCV</li>
  <li>Generate a look-up table mapping pixels in our front-facing camera to a
virtual birds-eye view</li>
  <li>Set the camera to take video in YUV color space (most cameras can do this
natively) – YUV is a perceptual color space, and makes it really easy to
find colors like yellow and orange</li>
  <li>Remap each image and use a convolutional filter on the virtual birdseye view
to find the lane lines (note: not a convolutional neural network or anything
like that, just a hand-designed function which “activates” on lane lines and is
relatively immune to lighting changes)</li>
  <li>Use linear regression to fit a parabola to the lines</li>
  <li>Compute <em>y<sub>e</sub></em>, <em>Ψ<sub>e</sub></em>, <em>κ</em> from the equation of
the parabola at the point where the fit was best.</li>
</ul>

<iframe width="560" height="315" src="./Fast line-following robots part 1_ control – a1k0n.net_files/esMiT7phZUM.html" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe>

<p>Of course, the measurement isn’t perfect and if you completely leave the track
or even just turn too far to one side, it provides no information on your
rapidly increasing <em>y<sub>e</sub></em>. This is why I added a Kalman filter to
track the line’s position relative to the car, and wheel encoders, brushless
motor sensor feedback, and/or MEMS gyroscopes can help tremendously with this
approach.</p>

<p>I will cover measuring and tracking in detail in my next post.</p>

<div class="footnotes">
  <ol>
    <li id="fn:1">
      <p>Alain Micaelli, Claude Samson. Trajectory tracking for unicycle-type and two-steering-wheels mobile robots. [Research Report] RR-2097, INRIA. 1993.&nbsp;<a href="https://www.a1k0n.net/2018/11/13/fast-line-following.html#fnref:1" class="reversefootnote">↩</a></p>
    </li>
  </ol>
</div>

</article>







      </div>
    </div>
  </div>

  <footer class="center">
  <div class="measure">
    <a href="https://www.a1k0n.net/" class="site-title">a1k0n.net</a>
  </div>
</footer>



<div style="position: absolute; width: 0px; height: 0px; overflow: hidden; padding: 0px; border: 0px; margin: 0px;"><div id="MathJax_Font_Test" style="position: absolute; visibility: hidden; top: 0px; left: 0px; width: auto; padding: 0px; border: 0px; margin: 0px; white-space: nowrap; text-align: left; text-indent: 0px; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; font-size: 40px; font-weight: normal; font-style: normal; font-family: MathJax_Size3, sans-serif;"></div></div></body></html>